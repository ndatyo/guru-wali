<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Guru Wali - Supabase Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Tambahkan Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        /* Style tetap sama seperti sebelumnya */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            background-color: #343a40;
            color: white;
            min-height: 100vh;
            padding-top: 20px;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background-color: #495057;
            color: white;
        }
        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .content {
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table thead {
            background-color: #0d6efd;
            color: white;
        }
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #6c757d;
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .journal-entry {
            border-left: 4px solid #0d6efd;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .journal-date {
            color: #6c757d;
            font-size: 14px;
        }
        .journal-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }
        .category-1 {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .category-2 {
            background-color: #d4edda;
            color: #155724;
        }
        .category-3 {
            background-color: #f8d7da;
            color: #721c24;
        }
        .journal-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .journal-info-item {
            display: flex;
            align-items: center;
        }
        .journal-info-item i {
            margin-right: 5px;
            color: #0d6efd;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }
        .status-1 {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .status-2 {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-3 {
            background-color: #f8d7da;
            color: #721c24;
        }
        .analysis-card {
            border-left: 4px solid #198754;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: #198754;
        }
        .analysis-date {
            color: #6c757d;
            font-size: 14px;
        }
        .user-info {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .user-info h5 {
            margin: 0;
            color: #495057;
        }
        .user-info small {
            color: #6c757d;
        }
        
        /* Print Styles - Professional PDF Layout */
        @media print {
            body {
                background-color: white;
                font-family: 'Times New Roman', Times, serif;
                font-size: 12pt;
                line-height: 1.5;
                color: #000;
                margin: 0;
                padding: 0;
            }
            
            .sidebar, .footer, .btn, .no-print, .modal, .back-button {
                display: none !important;
            }
            
            .container-fluid {
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .row {
                margin: 0;
            }
            
            .col-md-9 {
                width: 100%;
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: none;
                margin: 0;
                page-break-inside: avoid;
            }
            
            .card-header {
                display: none;
            }
            
            .card-body {
                padding: 0;
            }
            
            /* Professional Header */
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #000;
            }
            
            .print-header h2 {
                font-size: 16pt;
                font-weight: bold;
                margin: 0 0 5px 0;
                text-transform: uppercase;
            }
            
            .print-header p {
                font-size: 12pt;
                margin: 0;
                font-weight: bold;
            }
            
            .print-header .sekolah {
                font-size: 14pt;
                margin-bottom: 5px;
            }
            
            .print-header .alamat {
                font-size: 10pt;
                font-style: italic;
                margin-bottom: 10px;
            }
            
            /* Student Identity Section - Simplified */
            .student-identity {
                margin-bottom: 20px;
            }
            
            .student-info-row {
                display: flex;
                margin-bottom: 5px;
            }
            
            .student-info-label {
                width: 120px;
                font-weight: bold;
            }
            
            .student-info-value {
                flex: 1;
            }
            
            /* Title Section */
            .print-title {
                text-align: center;
                font-size: 14pt;
                font-weight: bold;
                margin-bottom: 15px;
                text-decoration: underline;
            }
            
            /* Table Styles */
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                font-size: 10pt;
            }
            
            .print-table th, .print-table td {
                border: 1px solid #000;
                padding: 6px 8px;
                text-align: left;
                vertical-align: top;
            }
            
            .print-table th {
                background-color: #e0e0e0;
                font-weight: bold;
                text-align: center;
            }
            
            .print-table td {
                word-wrap: break-word;
            }
            
            .print-table .no {
                text-align: center;
                width: 30px;
            }
            
            .print-table .tanggal {
                text-align: center;
                width: 80px;
            }
            
            .print-table .kategori, .print-table .status {
                text-align: center;
                width: 70px;
            }
            
            /* Signature Section */
            .signature-section {
                margin-top: 40px;
                display: flex;
                justify-content: space-between;
            }
            
            .signature-box {
                width: 45%;
                text-align: center;
            }
            
            .signature-box p {
                margin: 5px 0;
                font-size: 11pt;
            }
            
            .signature-box .signature-line {
                border-bottom: 1px solid #000;
                height: 40px;
                margin: 20px 0 5px 0;
            }
            
            .signature-box .nama {
                font-weight: bold;
            }
            
            .signature-box .jabatan {
                font-style: italic;
            }
            
            .signature-box .nip {
                font-size: 10pt;
            }
            
            /* Footer */
            .print-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 9pt;
                color: #666;
                border-top: 1px solid #000;
                padding-top: 5px;
                background-color: white;
            }
            
            /* Page Break */
            @page {
                size: A4;
                margin: 1cm;
                margin-bottom: 2cm;
            }
            
            /* Adjustments for better print layout */
            .mt-3, .mt-4, .mt-5 {
                margin-top: 15px !important;
            }
            
            h5 {
                font-size: 12pt;
                margin-bottom: 10px;
            }
            
            p {
                margin-bottom: 8px;
                font-size: 11pt;
            }
            
            .row > div {
                padding: 0;
            }
        }
        
        /* Back button styles */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Custom styles for import feature */
        .import-instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .import-instructions h6 {
            margin-top: 0;
            color: #0d6efd;
        }
        
        .import-instructions ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .import-preview {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .import-preview table {
            font-size: 14px;
        }
        
        .import-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .import-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .import-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .import-status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        /* Loading spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Halaman Login -->
    <div id="login-page" class="page">
        <div class="login-container">
            <div class="text-center mb-4">
                <h2><i class="bi bi-person-workspace"></i> Aplikasi Guru Wali</h2>
                <p class="text-muted">Silakan login untuk melanjutkan</p>
            </div>
            
            <ul class="nav nav-pills nav-justified mb-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-guru-tab" data-bs-toggle="pill" data-bs-target="#pills-guru" type="button" role="tab" aria-controls="pills-guru" aria-selected="true">Login Guru</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-admin-tab" data-bs-toggle="pill" data-bs-target="#pills-admin" type="button" role="tab" aria-controls="pills-admin" aria-selected="false">Login Admin</button>
                </li>
            </ul>
            
            <div class="tab-content" id="pills-tabContent">
                <!-- Form Login Guru -->
                <div class="tab-pane fade show active" id="pills-guru" role="tabpanel" aria-labelledby="pills-guru-tab">
                    <form id="login-guru-form">
                        <div class="mb-3">
                            <label for="username-guru" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username-guru" required>
                        </div>
                        <div class="mb-3">
                            <label for="password-guru" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password-guru" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
                
                <!-- Form Login Admin -->
                <div class="tab-pane fade" id="pills-admin" role="tabpanel" aria-labelledby="pills-admin-tab">
                    <form id="login-admin-form">
                        <div class="mb-3">
                            <label for="username-admin" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username-admin" required>
                        </div>
                        <div class="mb-3">
                            <label for="password-admin" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password-admin" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">Admin default: username: admin, password: admin123</small>
            </div>
        </div>
    </div>
    
    <!-- Halaman Admin -->
    <div id="admin-page" class="page hidden">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar Admin -->
                <div class="col-md-3 sidebar">
                    <div class="text-center mb-4">
                        <h4><i class="bi bi-shield-lock"></i> Admin Panel</h4>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showAdminPage('dashboard')">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                        <a class="nav-link" href="#" onclick="showAdminPage('kelola-guru')">
                            <i class="bi bi-person-plus"></i> Kelola Guru
                        </a>
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </nav>
                </div>
                
                <!-- Main Content Admin -->
                <div class="col-md-9 content">
                    <!-- Dashboard Admin -->
                    <div id="admin-dashboard-page" class="admin-page">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>Dashboard Admin</h2>
                            <div class="user-info">
                                <h5><i class="bi bi-person-circle"></i> Admin</h5>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-people"></i> Total Guru</h5>
                                        <p class="card-text fs-2" id="total-guru">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-person-lines-fill"></i> Total Siswa</h5>
                                        <p class="card-text fs-2" id="total-siswa">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-journal-text"></i> Total Jurnal</h5>
                                        <p class="card-text fs-2" id="total-jurnal">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Halaman Kelola Guru -->
                    <div id="admin-kelola-guru-page" class="admin-page hidden">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>Kelola Guru</h2>
                            <div class="user-info">
                                <h5><i class="bi bi-person-circle"></i> Admin</h5>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Data Guru</h5>
                                <div>
                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#importGuruModal">
                                        <i class="bi bi-file-earrow-up"></i> Import Guru
                                    </button>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#tambahGuruModal">
                                        <i class="bi bi-plus-circle"></i> Tambah Guru
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Nama Guru</th>
                                                <th>NIP</th>
                                                <th>Username</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabel-guru">
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    <div class="spinner-container">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Halaman Guru Wali -->
    <div id="guru-page" class="page hidden">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar Guru -->
                <div class="col-md-3 sidebar">
                    <div class="text-center mb-4">
                        <h4><i class="bi bi-person-workspace"></i> Guru Wali</h4>
                    </div>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showGuruPage('home')">
                            <i class="bi bi-house-door"></i> Beranda
                        </a>
                        <a class="nav-link" href="#" onclick="showGuruPage('manajemen-kelas')">
                            <i class="bi bi-people"></i> Manajemen Kelas
                        </a>
                        <a class="nav-link" href="#" onclick="showGuruPage('jurnal')">
                            <i class="bi bi-journal-text"></i> Jurnal Kegiatan
                        </a>
                        <a class="nav-link" href="#" onclick="showGuruPage('analisis')">
                            <i class="bi bi-graph-up"></i> Analisis Tindak Lanjut Jurnal
                        </a>
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </nav>
                </div>
                
                <!-- Main Content Guru -->
                <div class="col-md-9 content">
                    <!-- Info Guru -->
                    <div class="user-info">
                        <h5><i class="bi bi-person-circle"></i> <span id="nama-guru-login"></span></h5>
                        <small>Username: <span id="username-guru-login"></span></small>
                    </div>
                    
                    <!-- Halaman Beranda Guru -->
                    <div id="guru-home-page" class="guru-page">
                        <h2 class="mb-4">Selamat Datang di Aplikasi Guru Wali</h2>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-people"></i> Manajemen Kelas</h5>
                                        <p class="card-text">Kelola data siswa dalam kelas Anda.</p>
                                        <a href="#" class="btn btn-primary" onclick="showGuruPage('manajemen-kelas')">Buka Manajemen Kelas</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-journal-text"></i> Jurnal Kegiatan</h5>
                                        <p class="card-text">Catat kegiatan harian sebagai guru wali dan refleksikan hasilnya.</p>
                                        <a href="#" class="btn btn-primary" onclick="showGuruPage('jurnal')">Buka Jurnal Kegiatan</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-graph-up"></i> Analisis Tindak Lanjut</h5>
                                        <p class="card-text">Analisis evaluasi dan refleksi bimbingan siswa.</p>
                                        <a href="#" class="btn btn-primary" onclick="showGuruPage('analisis')">Buka Analisis</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5>Tugas Guru Wali</h5>
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="tugasAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingOne">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                1. Pendampingan Akademik
                                            </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#tugasAccordion">
                                            <div class="accordion-body">
                                                <ul>
                                                    <li>Memantau perkembangan akademik siswa</li>
                                                    <li>Mengatasi kesulitan belajar siswa</li>
                                                    <li>Koordinasi dengan guru mata pelajaran</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingTwo">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                                2. Pengembangan Kompetensi dan Keterampilan
                                            </button>
                                        </h2>
                                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#tugasAccordion">
                                            <div class="accordion-body">
                                                <ul>
                                                    <li>Mendorong potensi siswa</li>
                                                    <li>Memberi motivasi</li>
                                                    <li>Meningkatkan kompetensi kritis</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingThree">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                                3. Pembentukan Karakter
                                            </button>
                                        </h2>
                                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#tugasAccordion">
                                            <div class="accordion-body">
                                                <ul>
                                                    <li>Menanamkan nilai-nilai positif</li>
                                                    <li>Memberikan teladan</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Halaman Manajemen Kelas Guru -->
                    <div id="guru-manajemen-kelas-page" class="guru-page hidden">
                        <h2 class="mb-4">Manajemen Kelas</h2>
                        
                        <!-- Data Kepala Sekolah -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Data Kepala Sekolah</h5>
                            </div>
                            <div class="card-body">
                                <form id="kepala-sekolah-form">
                                    <div class="mb-3">
                                        <label for="nama-kepala-sekolah" class="form-label">Nama Kepala Sekolah</label>
                                        <input type="text" class="form-control" id="nama-kepala-sekolah" placeholder="Masukkan nama kepala sekolah">
                                    </div>
                                    <div class="mb-3">
                                        <label for="nip-kepala-sekolah" class="form-label">NIP</label>
                                        <input type="text" class="form-control" id="nip-kepala-sekolah" placeholder="Masukkan NIP kepala sekolah">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Simpan</button>
                                </form>
                                <div class="mt-3">
                                    <strong>Kepala Sekolah Terdaftar:</strong> <span id="kepala-sekolah-terdaftar">Belum ada data</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Siswa -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Data Siswa</h5>
                                <div>
                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#importSiswaModal">
                                        <i class="bi bi-file-earrow-up"></i> Import Siswa
                                    </button>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#tambahSiswaModal">
                                        <i class="bi bi-plus-circle"></i> Tambah Siswa
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Nama Siswa</th>
                                                <th>Kelas</th>
                                                <th>NIS</th>
                                                <th>NISN</th>
                                                <th>Jenis Kelamin</th>
                                                <th>Agama</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabel-siswa">
                                            <tr>
                                                <td colspan="8" class="text-center">
                                                    <div class="spinner-container">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Halaman Jurnal Guru -->
                    <div id="guru-jurnal-page" class="guru-page hidden">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2>Jurnal Kegiatan Guru Wali</h2>
                            <div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tambahJurnalModal">
                                    <i class="bi bi-plus-circle"></i> Tambah Catatan
                                </button>
                                <button class="btn btn-success ms-2" onclick="openCetakModal()">
                                    <i class="bi bi-printer"></i> Cetak Jurnal
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5>Catatan Jurnal</h5>
                            </div>
                            <div class="card-body">
                                <div id="daftar-jurnal">
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Halaman Analisis Tindak Lanjut Guru -->
                    <div id="guru-analisis-page" class="guru-page hidden">
                        <h2 class="mb-4">Analisis Tindak Lanjut Jurnal</h2>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Ringkasan Analisis</h5>
                            </div>
                            <div class="card-body">
                                <div id="ringkasan-analisis">
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5>Detail Analisis Tindak Lanjut</h5>
                            </div>
                            <div class="card-body">
                                <div id="daftar-analisis">
                                    <div class="spinner-container">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Halaman Cetak Jurnal -->
    <div id="cetak-jurnal-page" class="page hidden">
        <button class="back-button no-print" onclick="backToJurnal()">
            <i class="bi bi-arrow-left"></i> Kembali ke Jurnal
        </button>
        
        <div class="container-fluid">
            <div class="print-header">
                <h2>PEMERINTAH PROVINSI SUMATERA UTARA</h2>
                <h2>DINAS PENDIDIKAN</h2>
                <div class="sekolah">SMA NEGERI 20 MEDAN</div>
                <div class="alamat">Jl. Besar Bagan Deli, Medan Belawan</div>
            </div>
            
            <!-- Student Identity Section - Simplified -->
            <div id="student-identity-section" class="student-identity">
                <div id="student-info-container">
                    <!-- Student info will be populated here -->
                </div>
            </div>
            
            <div class="print-title">DAFTAR CATATAN JURNAL</div>
            
            <div id="cetak-daftar-jurnal">
                <div class="alert alert-info">
                    Tidak ada data jurnal untuk periode yang dipilih.
                </div>
            </div>
            
            <div class="print-footer">
                <p>© 2025 Aplikasi Guru Wali - SMA NEGERI 20 MEDAN</p>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2025 Aplikasi Guru Wali. Dikembangkan untuk mendukung tugas guru wali dalam pendidikan.</p>
    </div>
    
    <!-- Modal Tambah Guru -->
    <div class="modal fade" id="tambahGuruModal" tabindex="-1" aria-labelledby="tambahGuruModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tambahGuruModalLabel">Tambah Data Guru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="guru-form">
                        <div class="mb-3">
                            <label for="nama-guru-baru" class="form-label">Nama Guru</label>
                            <input type="text" class="form-control" id="nama-guru-baru" required>
                        </div>
                        <div class="mb-3">
                            <label for="nip-guru-baru" class="form-label">NIP</label>
                            <input type="text" class="form-control" id="nip-guru-baru" required>
                        </div>
                        <div class="mb-3">
                            <label for="username-guru-baru" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username-guru-baru" required>
                        </div>
                        <div class="mb-3">
                            <label for="password-guru-baru" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password-guru-baru" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveGuru()">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Import Guru -->
    <div class="modal fade" id="importGuruModal" tabindex="-1" aria-labelledby="importGuruModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importGuruModalLabel">Import Data Guru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="import-instructions">
                        <h6>Petunjuk Import Data Guru:</h6>
                        <ul>
                            <li>Format file harus berupa CSV (Comma Separated Values)</li>
                            <li>File harus memiliki header: nama,nip,username,password</li>
                            <li>Setiap baris mewakili satu data guru</li>
                            <li>Password minimal 6 karakter</li>
                            <li>Username harus unik</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="file-guru" class="form-label">Pilih File CSV</label>
                        <input type="file" class="form-control" id="file-guru" accept=".csv" required>
                    </div>
                    
                    <div id="guru-import-preview" class="import-preview hidden">
                        <h6>Preview Data:</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama</th>
                                        <th>NIP</th>
                                        <th>Username</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="guru-import-preview-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="guru-import-status" class="import-status hidden"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="process-guru-import-btn" onclick="processGuruImport()" disabled>Proses Import</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Tambah Siswa -->
    <div class="modal fade" id="tambahSiswaModal" tabindex="-1" aria-labelledby="tambahSiswaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tambahSiswaModalLabel">Tambah Data Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="siswa-form">
                        <div class="mb-3">
                            <label for="nama-siswa" class="form-label">Nama Siswa</label>
                            <input type="text" class="form-control" id="nama-siswa" required>
                        </div>
                        <div class="mb-3">
                            <label for="kelas-siswa" class="form-label">Kelas</label>
                            <input type="text" class="form-control" id="kelas-siswa" required>
                        </div>
                        <div class="mb-3">
                            <label for="nis-siswa" class="form-label">NIS</label>
                            <input type="text" class="form-control" id="nis-siswa" required>
                        </div>
                        <div class="mb-3">
                            <label for="nisn-siswa" class="form-label">NISN</label>
                            <input type="text" class="form-control" id="nisn-siswa" required>
                        </div>
                        <div class="mb-3">
                            <label for="jk-siswa" class="form-label">Jenis Kelamin</label>
                            <select class="form-select" id="jk-siswa" required>
                                <option value="">Pilih jenis kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="agama-siswa" class="form-label">Agama</label>
                            <select class="form-select" id="agama-siswa" required>
                                <option value="">Pilih agama</option>
                                <option value="Islam">Islam</option>
                                <option value="Kristen">Kristen</option>
                                <option value="Katolik">Katolik</option>
                                <option value="Hindu">Hindu</option>
                                <option value="Buddha">Buddha</option>
                                <option value="Konghucu">Konghucu</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveSiswa()">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Import Siswa -->
    <div class="modal fade" id="importSiswaModal" tabindex="-1" aria-labelledby="importSiswaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importSiswaModalLabel">Import Data Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="import-instructions">
                        <h6>Petunjuk Import Data Siswa:</h6>
                        <ul>
                            <li>Format file harus berupa CSV (Comma Separated Values)</li>
                            <li>File harus memiliki header: nama,kelas,nis,nisn,jenis_kelamin,agama</li>
                            <li>Setiap baris mewakili satu data siswa</li>
                            <li>Jenis kelamin: Laki-laki atau Perempuan</li>
                            <li>Agama: Islam, Kristen, Katolik, Hindu, Buddha, atau Konghucu</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="file-siswa" class="form-label">Pilih File CSV</label>
                        <input type="file" class="form-control" id="file-siswa" accept=".csv" required>
                    </div>
                    
                    <div id="siswa-import-preview" class="import-preview hidden">
                        <h6>Preview Data:</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama</th>
                                        <th>Kelas</th>
                                        <th>NIS</th>
                                        <th>NISN</th>
                                        <th>Jenis Kelamin</th>
                                        <th>Agama</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="siswa-import-preview-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="siswa-import-status" class="import-status hidden"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="process-siswa-import-btn" onclick="processSiswaImport()" disabled>Proses Import</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Tambah/Edit Jurnal -->
    <div class="modal fade" id="tambahJurnalModal" tabindex="-1" aria-labelledby="tambahJurnalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tambahJurnalModalLabel">Tambah Catatan Jurnal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="jurnal-form">
                        <input type="hidden" id="jurnal-id">
                        <div class="mb-3">
                            <label for="siswa-jurnal" class="form-label">Siswa</label>
                            <select class="form-select" id="siswa-jurnal" required>
                                <option value="">Pilih siswa</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tanggal-jurnal" class="form-label">Tanggal Kegiatan</label>
                            <input type="date" class="form-control" id="tanggal-jurnal" required>
                        </div>
                        <div class="mb-3">
                            <label for="kategori-jurnal" class="form-label">Kategori Tugas</label>
                            <select class="form-select" id="kategori-jurnal" required>
                                <option value="">Pilih kategori</option>
                                <option value="1">Pendampingan Akademik</option>
                                <option value="2">Pengembangan Kompetensi dan Keterampilan</option>
                                <option value="3">Pembentukan Karakter</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kegiatan-jurnal" class="form-label">Kegiatan yang Dilakukan</label>
                            <textarea class="form-control" id="kegiatan-jurnal" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="evaluasi-tindak-lanjut-jurnal" class="form-label">Evaluasi dan Tindak Lanjut</label>
                            <textarea class="form-control" id="evaluasi-tindak-lanjut-jurnal" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="status-jurnal" class="form-label">Status Bimbingan</label>
                            <select class="form-select" id="status-jurnal" required>
                                <option value="">Pilih status bimbingan</option>
                                <option value="1">Baik - Kondisi Positif</option>
                                <option value="2">Perlu Perhatian - Butuh Monitoring</option>
                                <option value="3">Butuh Bantuan - Perlu Intervensi</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="refleksi-jurnal" class="form-label">Refleksi</label>
                            <textarea class="form-control" id="refleksi-jurnal" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveJurnal()">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Cetak Jurnal -->
    <div class="modal fade" id="cetakJurnalModal" tabindex="-1" aria-labelledby="cetakJurnalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cetakJurnalModalLabel">Cetak Jurnal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cetak-form">
                        <div class="mb-3">
                            <label for="siswa-cetak" class="form-label">Siswa</label>
                            <select class="form-select" id="siswa-cetak">
                                <option value="">Semua Siswa</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tanggal-mulai-cetak" class="form-label">Tanggal Mulai</label>
                                    <input type="date" class="form-control" id="tanggal-mulai-cetak">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tanggal-selesai-cetak" class="form-label">Tanggal Selesai</label>
                                    <input type="date" class="form-control" id="tanggal-selesai-cetak">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="prepareCetak()">Preview & Cetak</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Konfigurasi Supabase - GANTI dengan URL dan KEY dari project Supabase Anda
        const SUPABASE_URL = 'https://whkwjlxtrsviyrknfesx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indoa3dqbHh0cnN2aXlya25mZXN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjA3ODgsImV4cCI6MjA3NDI5Njc4OH0.w2EAial0YRpoEhNfCiPSd1UZOmUQZUN9WjikaCtTt_s';
        
        // Inisialisasi Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Data storage
        let currentGuru = null;
        let dataKepalaSekolah = { nama: '', nip: '' };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('tanggal-jurnal').valueAsDate = new Date();
            
            // Check if user is already logged in
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const userData = JSON.parse(loggedInUser);
                if (userData.role === 'admin') {
                    showAdminDashboard();
                } else {
                    currentGuru = userData;
                    showGuruDashboard();
                }
            }
            
            // Load kepala sekolah data
            loadKepalaSekolah();
            
            // Setup file input listeners for import features
            setupImportListeners();
        });
        
        // Setup import file listeners
        function setupImportListeners() {
            // Guru import listener
            document.getElementById('file-guru').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    previewGuruImport(file);
                }
            });
            
            // Siswa import listener
            document.getElementById('file-siswa').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    previewSiswaImport(file);
                }
            });
        }
        
        // Load kepala sekolah data
        async function loadKepalaSekolah() {
            try {
                const { data, error } = await supabase
                    .from('headmasters')
                    .select('*')
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    console.error('Error loading headmaster:', error);
                    return;
                }
                
                if (data) {
                    dataKepalaSekolah = {
                        id: data.id,
                        nama: data.nama,
                        nip: data.nip
                    };
                    
                    document.getElementById('nama-kepala-sekolah').value = dataKepalaSekolah.nama;
                    document.getElementById('nip-kepala-sekolah').value = dataKepalaSekolah.nip;
                    document.getElementById('kepala-sekolah-terdaftar').textContent = `${dataKepalaSekolah.nama} (${dataKepalaSekolah.nip})`;
                }
            } catch (error) {
                console.error('Error in loadKepalaSekolah:', error);
            }
        }
        
        // Login functions
        document.getElementById('login-guru-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username-guru').value;
            const password = document.getElementById('password-guru').value;
            
            try {
                // Find teacher in database
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('role', 'guru')
                    .single();
                
                if (error) {
                    alert('Username atau password salah!');
                    return;
                }
                
                if (data) {
                    currentGuru = {
                        id: data.id,
                        nama: data.nama,
                        nip: data.nip,
                        username: data.username,
                        role: 'guru'
                    };
                    
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentGuru));
                    showGuruDashboard();
                }
            } catch (error) {
                console.error('Error in login:', error);
                alert('Terjadi kesalahan saat login. Silakan coba lagi.');
            }
        });
        
        document.getElementById('login-admin-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username-admin').value;
            const password = document.getElementById('password-admin').value;
            
            // Check admin credentials (default: admin/admin123)
            if (username === 'admin' && password === 'admin123') {
                const adminUser = {
                    username: username,
                    role: 'admin'
                };
                
                sessionStorage.setItem('loggedInUser', JSON.stringify(adminUser));
                showAdminDashboard();
            } else {
                alert('Username atau password salah!');
            }
        });
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('loggedInUser');
            currentGuru = null;
            showLoginPage();
        }
        
        // Page navigation functions
        function showLoginPage() {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show login page
            document.getElementById('login-page').classList.remove('hidden');
        }
        
        function showAdminDashboard() {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show admin page
            document.getElementById('admin-page').classList.remove('hidden');
            
            // Show dashboard subpage
            showAdminPage('dashboard');
            
            // Update dashboard stats
            updateAdminDashboardStats();
        }
        
        function showGuruDashboard() {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show guru page
            document.getElementById('guru-page').classList.remove('hidden');
            
            // Update guru info
            document.getElementById('nama-guru-login').textContent = currentGuru.nama;
            document.getElementById('username-guru-login').textContent = currentGuru.username;
            
            // Show home subpage
            showGuruPage('home');
            
            // Load guru's data
            loadGuruData();
        }
        
        function showAdminPage(pageId) {
            // Hide all admin subpages
            const adminPages = document.querySelectorAll('.admin-page');
            adminPages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected admin subpage
            document.getElementById(`admin-${pageId}-page`).classList.remove('hidden');
            
            // Update active nav link
            const navLinks = document.querySelectorAll('#admin-page .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // Find the link that matches the page and set it as active
            navLinks.forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                }
            });
            
            // Load data for specific pages
            if (pageId === 'kelola-guru') {
                renderTabelGuru();
            }
        }
        
        function showGuruPage(pageId) {
            // Hide all guru subpages
            const guruPages = document.querySelectorAll('.guru-page');
            guruPages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected guru subpage
            document.getElementById(`guru-${pageId}-page`).classList.remove('hidden');
            
            // Update active nav link
            const navLinks = document.querySelectorAll('#guru-page .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // Find the link that matches the page and set it as active
            navLinks.forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                }
            });
            
            // Load data for specific pages
            if (pageId === 'manajemen-kelas') {
                renderTabelSiswa();
            } else if (pageId === 'jurnal') {
                renderJurnal();
                updateSiswaOptions();
            } else if (pageId === 'analisis') {
                renderAnalisis();
            }
        }
        
        // Function to show print page
        function showPrintPage() {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show print page
            document.getElementById('cetak-jurnal-page').classList.remove('hidden');
        }
        
        // Function to go back to journal page
        function backToJurnal() {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show guru page
            document.getElementById('guru-page').classList.remove('hidden');
            
            // Show journal subpage
            showGuruPage('jurnal');
        }
        
        // Admin functions
        async function updateAdminDashboardStats() {
            try {
                // Get total teachers
                const { data: guruData, error: guruError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact' })
                    .eq('role', 'guru');
                
                // Get total students
                const { data: siswaData, error: siswaError } = await supabase
                    .from('students')
                    .select('*', { count: 'exact' });
                
                // Get total journals
                const { data: jurnalData, error: jurnalError } = await supabase
                    .from('journals')
                    .select('*', { count: 'exact' });
                
                if (guruError || siswaError || jurnalError) {
                    console.error('Error loading dashboard stats:', guruError || siswaError || jurnalError);
                    return;
                }
                
                // Update UI
                document.getElementById('total-guru').textContent = guruData.length || 0;
                document.getElementById('total-siswa').textContent = siswaData.length || 0;
                document.getElementById('total-jurnal').textContent = jurnalData.length || 0;
            } catch (error) {
                console.error('Error in updateAdminDashboardStats:', error);
            }
        }
        
        async function saveGuru() {
            const namaGuru = document.getElementById('nama-guru-baru').value;
            const nipGuru = document.getElementById('nip-guru-baru').value;
            const usernameGuru = document.getElementById('username-guru-baru').value;
            const passwordGuru = document.getElementById('password-guru-baru').value;
            
            if (namaGuru && nipGuru && usernameGuru && passwordGuru) {
                try {
                    // Check if username already exists
                    const { data: existingUser, error: checkError } = await supabase
                        .from('users')
                        .select('username')
                        .eq('username', usernameGuru)
                        .single();
                    
                    if (existingUser) {
                        alert('Username sudah digunakan!');
                        return;
                    }
                    
                    // Insert new teacher
                    const { data, error } = await supabase
                        .from('users')
                        .insert([
                            {
                                nama: namaGuru,
                                nip: nipGuru,
                                username: usernameGuru,
                                password: passwordGuru,
                                role: 'guru'
                            }
                        ])
                        .select();
                    
                    if (error) {
                        console.error('Error saving teacher:', error);
                        alert('Gagal menyimpan data guru: ' + error.message);
                        return;
                    }
                    
                    renderTabelGuru();
                    updateAdminDashboardStats();
                    
                    // Reset form and close modal
                    document.getElementById('guru-form').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tambahGuruModal'));
                    modal.hide();
                    
                    alert('Data guru berhasil ditambahkan!');
                } catch (error) {
                    console.error('Error in saveGuru:', error);
                    alert('Terjadi kesalahan saat menyimpan data guru.');
                }
            }
        }
        
        async function renderTabelGuru() {
            const tabelBody = document.getElementById('tabel-guru');
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('role', 'guru');
                
                if (error) {
                    console.error('Error loading teachers:', error);
                    tabelBody.innerHTML = '<tr><td colspan="5" class="text-center">Gagal memuat data guru</td></tr>';
                    return;
                }
                
                if (data.length === 0) {
                    tabelBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada data guru</td></tr>';
                    return;
                }
                
                let html = '';
                data.forEach((guru, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${guru.nama}</td>
                            <td>${guru.nip}</td>
                            <td>${guru.username}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteGuru('${guru.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabelBody.innerHTML = html;
            } catch (error) {
                console.error('Error in renderTabelGuru:', error);
                tabelBody.innerHTML = '<tr><td colspan="5" class="text-center">Gagal memuat data guru</td></tr>';
            }
        }
        
        async function deleteGuru(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data guru ini? Semua data terkait guru ini juga akan dihapus.')) {
                try {
                    const { error } = await supabase
                        .from('users')
                        .delete()
                        .eq('id', id);
                    
                    if (error) {
                        console.error('Error deleting teacher:', error);
                        alert('Gagal menghapus data guru: ' + error.message);
                        return;
                    }
                    
                    renderTabelGuru();
                    updateAdminDashboardStats();
                    alert('Data guru berhasil dihapus!');
                } catch (error) {
                    console.error('Error in deleteGuru:', error);
                    alert('Terjadi kesalahan saat menghapus data guru.');
                }
            }
        }
        
        // Import Guru functions
        function previewGuruImport(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Check if file has header
                if (lines.length < 2) {
                    showGuruImportStatus('error', 'File tidak valid atau tidak memiliki data');
                    return;
                }
                
                // Parse header
                const header = lines[0].split(',').map(h => h.trim());
                const expectedHeader = ['nama', 'nip', 'username', 'password'];
                
                // Check if header matches expected format
                if (!expectedHeader.every(col => header.includes(col))) {
                    showGuruImportStatus('error', 'Format header tidak valid. Header harus berisi: nama,nip,username,password');
                    return;
                }
                
                // Parse data rows
                const previewData = [];
                let hasError = false;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const values = line.split(',').map(v => v.trim());
                    
                    if (values.length !== header.length) {
                        hasError = true;
                        previewData.push({
                            row: i,
                            nama: values[0] || '',
                            nip: values[1] || '',
                            username: values[2] || '',
                            password: values[3] || '',
                            status: 'Format tidak valid'
                        });
                        continue;
                    }
                    
                    const rowData = {};
                    header.forEach((col, index) => {
                        rowData[col] = values[index];
                    });
                    
                    // Validate data
                    let status = 'Valid';
                    let errorMsg = '';
                    
                    if (!rowData.nama) {
                        status = 'Error';
                        errorMsg = 'Nama tidak boleh kosong';
                    } else if (!rowData.nip) {
                        status = 'Error';
                        errorMsg = 'NIP tidak boleh kosong';
                    } else if (!rowData.username) {
                        status = 'Error';
                        errorMsg = 'Username tidak boleh kosong';
                    } else if (!rowData.password || rowData.password.length < 6) {
                        status = 'Error';
                        errorMsg = 'Password minimal 6 karakter';
                    }
                    
                    if (status === 'Error') {
                        hasError = true;
                    }
                    
                    previewData.push({
                        row: i,
                        nama: rowData.nama,
                        nip: rowData.nip,
                        username: rowData.username,
                        password: '••••••',
                        status: status + (errorMsg ? ': ' + errorMsg : '')
                    });
                }
                
                // Display preview
                displayGuruImportPreview(previewData);
                
                // Enable/disable import button based on errors
                const importBtn = document.getElementById('process-guru-import-btn');
                importBtn.disabled = hasError || previewData.length === 0;
                
                if (hasError) {
                    showGuruImportStatus('warning', 'Terdapat data yang tidak valid. Perbaiki data tersebut sebelum melakukan import.');
                } else if (previewData.length > 0) {
                    showGuruImportStatus('success', `File valid. ${previewData.length} data guru siap diimport.`);
                }
            };
            
            reader.readAsText(file);
        }
        
        function displayGuruImportPreview(data) {
            const previewContainer = document.getElementById('guru-import-preview');
            const previewBody = document.getElementById('guru-import-preview-body');
            
            let html = '';
            data.forEach(item => {
                const statusClass = item.status.includes('Error') ? 'text-danger' : 
                                   item.status.includes('Valid') ? 'text-success' : 'text-warning';
                
                html += `
                    <tr>
                        <td>${item.row}</td>
                        <td>${item.nama}</td>
                        <td>${item.nip}</td>
                        <td>${item.username}</td>
                        <td class="${statusClass}">${item.status}</td>
                    </tr>
                `;
            });
            
            previewBody.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }
        
        function showGuruImportStatus(type, message) {
            const statusContainer = document.getElementById('guru-import-status');
            statusContainer.className = 'import-status ' + type;
            statusContainer.textContent = message;
            statusContainer.classList.remove('hidden');
        }
        
        async function processGuruImport() {
            const fileInput = document.getElementById('file-guru');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Parse header
                const header = lines[0].split(',').map(h => h.trim());
                
                // Parse data rows
                let successCount = 0;
                let errorCount = 0;
                const teachersToInsert = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const values = line.split(',').map(v => v.trim());
                    
                    if (values.length !== header.length) {
                        errorCount++;
                        continue;
                    }
                    
                    const rowData = {};
                    header.forEach((col, index) => {
                        rowData[col] = values[index];
                    });
                    
                    // Validate data
                    if (!rowData.nama || !rowData.nip || !rowData.username || 
                        !rowData.password || rowData.password.length < 6) {
                        errorCount++;
                        continue;
                    }
                    
                    // Add to array for batch insert
                    teachersToInsert.push({
                        nama: rowData.nama,
                        nip: rowData.nip,
                        username: rowData.username,
                        password: rowData.password,
                        role: 'guru'
                    });
                    
                    successCount++;
                }
                
                if (teachersToInsert.length > 0) {
                    try {
                        const { data, error } = await supabase
                            .from('users')
                            .insert(teachersToInsert)
                            .select();
                        
                        if (error) {
                            console.error('Error importing teachers:', error);
                            showGuruImportStatus('error', `Gagal import: ${error.message}`);
                            return;
                        }
                        
                        // Update UI
                        renderTabelGuru();
                        updateAdminDashboardStats();
                        
                        // Show result
                        showGuruImportStatus('success', `Import selesai. ${successCount} data berhasil diimport, ${errorCount} data gagal.`);
                        
                        // Reset form
                        fileInput.value = '';
                        document.getElementById('guru-import-preview').classList.add('hidden');
                        document.getElementById('process-guru-import-btn').disabled = true;
                    } catch (error) {
                        console.error('Error in processGuruImport:', error);
                        showGuruImportStatus('error', 'Terjadi kesalahan saat import data guru.');
                    }
                }
            };
            
            reader.readAsText(file);
        }
        
        // Kepala sekolah functions
        document.getElementById('kepala-sekolah-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const namaKepalaSekolah = document.getElementById('nama-kepala-sekolah').value;
            const nipKepalaSekolah = document.getElementById('nip-kepala-sekolah').value;
            
            if (namaKepalaSekolah && nipKepalaSekolah) {
                try {
                    if (dataKepalaSekolah.id) {
                        // Update existing headmaster
                        const { error } = await supabase
                            .from('headmasters')
                            .update({
                                nama: namaKepalaSekolah,
                                nip: nipKepalaSekolah
                            })
                            .eq('id', dataKepalaSekolah.id);
                        
                        if (error) {
                            console.error('Error updating headmaster:', error);
                            alert('Gagal memperbarui data kepala sekolah: ' + error.message);
                            return;
                        }
                    } else {
                        // Insert new headmaster
                        const { data, error } = await supabase
                            .from('headmasters')
                            .insert([
                                {
                                    nama: namaKepalaSekolah,
                                    nip: nipKepalaSekolah
                                }
                            ])
                            .select();
                        
                        if (error) {
                            console.error('Error saving headmaster:', error);
                            alert('Gagal menyimpan data kepala sekolah: ' + error.message);
                            return;
                        }
                        
                        if (data && data.length > 0) {
                            dataKepalaSekolah = {
                                id: data[0].id,
                                nama: data[0].nama,
                                nip: data[0].nip
                            };
                        }
                    }
                    
                    document.getElementById('kepala-sekolah-terdaftar').textContent = `${namaKepalaSekolah} (${nipKepalaSekolah})`;
                    
                    alert('Data kepala sekolah berhasil disimpan!');
                } catch (error) {
                    console.error('Error in saving headmaster:', error);
                    alert('Terjadi kesalahan saat menyimpan data kepala sekolah.');
                }
            }
        });
        
        // Guru functions
        function loadGuruData() {
            // Load teacher's students and journals
            renderTabelSiswa();
            renderJurnal();
            renderAnalisis();
            updateSiswaOptions();
        }
        
        async function saveSiswa() {
            const namaSiswa = document.getElementById('nama-siswa').value;
            const kelasSiswa = document.getElementById('kelas-siswa').value;
            const nisSiswa = document.getElementById('nis-siswa').value;
            const nisnSiswa = document.getElementById('nisn-siswa').value;
            const jkSiswa = document.getElementById('jk-siswa').value;
            const agamaSiswa = document.getElementById('agama-siswa').value;
            
            if (namaSiswa && kelasSiswa && nisSiswa && nisnSiswa && jkSiswa && agamaSiswa) {
                try {
                    const { data, error } = await supabase
                        .from('students')
                        .insert([
                            {
                                guru_id: currentGuru.id,
                                nama: namaSiswa,
                                kelas: kelasSiswa,
                                nis: nisSiswa,
                                nisn: nisnSiswa,
                                jk: jkSiswa,
                                agama: agamaSiswa
                            }
                        ])
                        .select();
                    
                    if (error) {
                        console.error('Error saving student:', error);
                        alert('Gagal menyimpan data siswa: ' + error.message);
                        return;
                    }
                    
                    renderTabelSiswa();
                    updateSiswaOptions();
                    
                    // Reset form and close modal
                    document.getElementById('siswa-form').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tambahSiswaModal'));
                    modal.hide();
                    
                    alert('Data siswa berhasil ditambahkan!');
                } catch (error) {
                    console.error('Error in saveSiswa:', error);
                    alert('Terjadi kesalahan saat menyimpan data siswa.');
                }
            }
        }
        
        async function updateSiswaOptions() {
            const siswaSelect = document.getElementById('siswa-jurnal');
            siswaSelect.innerHTML = '<option value="">Pilih siswa</option>';
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('guru_id', currentGuru.id);
                
                if (error) {
                    console.error('Error loading students:', error);
                    return;
                }
                
                if (data) {
                    data.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.id;
                        option.textContent = `${siswa.nama} (${siswa.kelas})`;
                        siswaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error in updateSiswaOptions:', error);
            }
        }
        
        async function renderTabelSiswa() {
            const tabelBody = document.getElementById('tabel-siswa');
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('guru_id', currentGuru.id);
                
                if (error) {
                    console.error('Error loading students:', error);
                    tabelBody.innerHTML = '<tr><td colspan="8" class="text-center">Gagal memuat data siswa</td></tr>';
                    return;
                }
                
                if (data.length === 0) {
                    tabelBody.innerHTML = '<tr><td colspan="8" class="text-center">Belum ada data siswa</td></tr>';
                    return;
                }
                
                let html = '';
                data.forEach((siswa, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${siswa.nama}</td>
                            <td>${siswa.kelas}</td>
                            <td>${siswa.nis}</td>
                            <td>${siswa.nisn}</td>
                            <td>${siswa.jk}</td>
                            <td>${siswa.agama}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteSiswa('${siswa.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabelBody.innerHTML = html;
            } catch (error) {
                console.error('Error in renderTabelSiswa:', error);
                tabelBody.innerHTML = '<tr><td colspan="8" class="text-center">Gagal memuat data siswa</td></tr>';
            }
        }
        
        async function deleteSiswa(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) {
                try {
                    const { error } = await supabase
                        .from('students')
                        .delete()
                        .eq('id', id);
                    
                    if (error) {
                        console.error('Error deleting student:', error);
                        alert('Gagal menghapus data siswa: ' + error.message);
                        return;
                    }
                    
                    renderTabelSiswa();
                    updateSiswaOptions();
                    alert('Data siswa berhasil dihapus!');
                } catch (error) {
                    console.error('Error in deleteSiswa:', error);
                    alert('Terjadi kesalahan saat menghapus data siswa.');
                }
            }
        }
        
        // Import Siswa functions
        function previewSiswaImport(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Check if file has header
                if (lines.length < 2) {
                    showSiswaImportStatus('error', 'File tidak valid atau tidak memiliki data');
                    return;
                }
                
                // Parse header
                const header = lines[0].split(',').map(h => h.trim());
                const expectedHeader = ['nama', 'kelas', 'nis', 'nisn', 'jenis_kelamin', 'agama'];
                
                // Check if header matches expected format
                if (!expectedHeader.every(col => header.includes(col))) {
                    showSiswaImportStatus('error', 'Format header tidak valid. Header harus berisi: nama,kelas,nis,nisn,jenis_kelamin,agama');
                    return;
                }
                
                // Parse data rows
                const previewData = [];
                let hasError = false;
                const validAgama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
                const validJenisKelamin = ['Laki-laki', 'Perempuan'];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const values = line.split(',').map(v => v.trim());
                    
                    if (values.length !== header.length) {
                        hasError = true;
                        previewData.push({
                            row: i,
                            nama: values[0] || '',
                            kelas: values[1] || '',
                            nis: values[2] || '',
                            nisn: values[3] || '',
                            jenis_kelamin: values[4] || '',
                            agama: values[5] || '',
                            status: 'Format tidak valid'
                        });
                        continue;
                    }
                    
                    const rowData = {};
                    header.forEach((col, index) => {
                        rowData[col] = values[index];
                    });
                    
                    // Validate data
                    let status = 'Valid';
                    let errorMsg = '';
                    
                    if (!rowData.nama) {
                        status = 'Error';
                        errorMsg = 'Nama tidak boleh kosong';
                    } else if (!rowData.kelas) {
                        status = 'Error';
                        errorMsg = 'Kelas tidak boleh kosong';
                    } else if (!rowData.nis) {
                        status = 'Error';
                        errorMsg = 'NIS tidak boleh kosong';
                    } else if (!rowData.nisn) {
                        status = 'Error';
                        errorMsg = 'NISN tidak boleh kosong';
                    } else if (!validJenisKelamin.includes(rowData.jenis_kelamin)) {
                        status = 'Error';
                        errorMsg = 'Jenis kelamin tidak valid (harus Laki-laki atau Perempuan)';
                    } else if (!validAgama.includes(rowData.agama)) {
                        status = 'Error';
                        errorMsg = 'Agama tidak valid';
                    }
                    
                    if (status === 'Error') {
                        hasError = true;
                    }
                    
                    previewData.push({
                        row: i,
                        nama: rowData.nama,
                        kelas: rowData.kelas,
                        nis: rowData.nis,
                        nisn: rowData.nisn,
                        jenis_kelamin: rowData.jenis_kelamin,
                        agama: rowData.agama,
                        status: status + (errorMsg ? ': ' + errorMsg : '')
                    });
                }
                
                // Display preview
                displaySiswaImportPreview(previewData);
                
                // Enable/disable import button based on errors
                const importBtn = document.getElementById('process-siswa-import-btn');
                importBtn.disabled = hasError || previewData.length === 0;
                
                if (hasError) {
                    showSiswaImportStatus('warning', 'Terdapat data yang tidak valid. Perbaiki data tersebut sebelum melakukan import.');
                } else if (previewData.length > 0) {
                    showSiswaImportStatus('success', `File valid. ${previewData.length} data siswa siap diimport.`);
                }
            };
            
            reader.readAsText(file);
        }
        
        function displaySiswaImportPreview(data) {
            const previewContainer = document.getElementById('siswa-import-preview');
            const previewBody = document.getElementById('siswa-import-preview-body');
            
            let html = '';
            data.forEach(item => {
                const statusClass = item.status.includes('Error') ? 'text-danger' : 
                                   item.status.includes('Valid') ? 'text-success' : 'text-warning';
                
                html += `
                    <tr>
                        <td>${item.row}</td>
                        <td>${item.nama}</td>
                        <td>${item.kelas}</td>
                        <td>${item.nis}</td>
                        <td>${item.nisn}</td>
                        <td>${item.jenis_kelamin}</td>
                        <td>${item.agama}</td>
                        <td class="${statusClass}">${item.status}</td>
                    </tr>
                `;
            });
            
            previewBody.innerHTML = html;
            previewContainer.classList.remove('hidden');
        }
        
        function showSiswaImportStatus(type, message) {
            const statusContainer = document.getElementById('siswa-import-status');
            statusContainer.className = 'import-status ' + type;
            statusContainer.textContent = message;
            statusContainer.classList.remove('hidden');
        }
        
        async function processSiswaImport() {
            const fileInput = document.getElementById('file-siswa');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                
                // Parse header
                const header = lines[0].split(',').map(h => h.trim());
                
                // Parse data rows
                let successCount = 0;
                let errorCount = 0;
                const studentsToInsert = [];
                const validAgama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
                const validJenisKelamin = ['Laki-laki', 'Perempuan'];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const values = line.split(',').map(v => v.trim());
                    
                    if (values.length !== header.length) {
                        errorCount++;
                        continue;
                    }
                    
                    const rowData = {};
                    header.forEach((col, index) => {
                        rowData[col] = values[index];
                    });
                    
                    // Validate data
                    if (!rowData.nama || !rowData.kelas || !rowData.nis || !rowData.nisn ||
                        !validJenisKelamin.includes(rowData.jenis_kelamin) || 
                        !validAgama.includes(rowData.agama)) {
                        errorCount++;
                        continue;
                    }
                    
                    // Add to array for batch insert
                    studentsToInsert.push({
                        guru_id: currentGuru.id,
                        nama: rowData.nama,
                        kelas: rowData.kelas,
                        nis: rowData.nis,
                        nisn: rowData.nisn,
                        jk: rowData.jenis_kelamin,
                        agama: rowData.agama
                    });
                    
                    successCount++;
                }
                
                if (studentsToInsert.length > 0) {
                    try {
                        const { data, error } = await supabase
                            .from('students')
                            .insert(studentsToInsert)
                            .select();
                        
                        if (error) {
                            console.error('Error importing students:', error);
                            showSiswaImportStatus('error', `Gagal import: ${error.message}`);
                            return;
                        }
                        
                        // Update UI
                        renderTabelSiswa();
                        updateSiswaOptions();
                        
                        // Show result
                        showSiswaImportStatus('success', `Import selesai. ${successCount} data berhasil diimport, ${errorCount} data gagal.`);
                        
                        // Reset form
                        fileInput.value = '';
                        document.getElementById('siswa-import-preview').classList.add('hidden');
                        document.getElementById('process-siswa-import-btn').disabled = true;
                    } catch (error) {
                        console.error('Error in processSiswaImport:', error);
                        showSiswaImportStatus('error', 'Terjadi kesalahan saat import data siswa.');
                    }
                }
            };
            
            reader.readAsText(file);
        }
        
        async function openEditJurnalModal(id) {
            try {
                // Find journal data
                const { data: jurnal, error } = await supabase
                    .from('journals')
                    .select(`
                        *,
                        students (id, nama, kelas)
                    `)
                    .eq('id', id)
                    .single();
                
                if (error || !jurnal) {
                    console.error('Error loading journal:', error);
                    return;
                }
                
                // Fill form with journal data
                document.getElementById('jurnal-id').value = jurnal.id;
                document.getElementById('siswa-jurnal').value = jurnal.siswa_id;
                document.getElementById('tanggal-jurnal').value = jurnal.tanggal;
                document.getElementById('kategori-jurnal').value = jurnal.kategori;
                document.getElementById('kegiatan-jurnal').value = jurnal.kegiatan;
                document.getElementById('evaluasi-tindak-lanjut-jurnal').value = jurnal.evaluasi_tindak_lanjut;
                document.getElementById('status-jurnal').value = jurnal.status;
                document.getElementById('refleksi-jurnal').value = jurnal.refleksi;
                
                // Update modal title
                document.getElementById('tambahJurnalModalLabel').textContent = 'Edit Catatan Jurnal';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('tambahJurnalModal'));
                modal.show();
            } catch (error) {
                console.error('Error in openEditJurnalModal:', error);
            }
        }
        
        async function saveJurnal() {
            const jurnalId = document.getElementById('jurnal-id').value;
            const siswaId = document.getElementById('siswa-jurnal').value;
            const tanggal = document.getElementById('tanggal-jurnal').value;
            const kategori = document.getElementById('kategori-jurnal').value;
            const kegiatan = document.getElementById('kegiatan-jurnal').value;
            const evaluasiTindakLanjut = document.getElementById('evaluasi-tindak-lanjut-jurnal').value;
            const status = document.getElementById('status-jurnal').value;
            const refleksi = document.getElementById('refleksi-jurnal').value;
            
            if (siswaId && tanggal && kategori && kegiatan && evaluasiTindakLanjut && status && refleksi) {
                try {
                    const jurnalData = {
                        guru_id: currentGuru.id,
                        siswa_id: siswaId,
                        tanggal: tanggal,
                        kategori: parseInt(kategori),
                        kegiatan: kegiatan,
                        evaluasi_tindak_lanjut: evaluasiTindakLanjut,
                        status: parseInt(status),
                        refleksi: refleksi
                    };
                    
                    let result;
                    
                    if (jurnalId) {
                        // Update existing journal
                        result = await supabase
                            .from('journals')
                            .update(jurnalData)
                            .eq('id', jurnalId)
                            .select();
                        
                        if (result.error) {
                            console.error('Error updating journal:', result.error);
                            alert('Gagal memperbarui catatan jurnal: ' + result.error.message);
                            return;
                        }
                        
                        alert('Catatan jurnal berhasil diperbarui!');
                    } else {
                        // Add new journal
                        result = await supabase
                            .from('journals')
                            .insert(jurnalData)
                            .select();
                        
                        if (result.error) {
                            console.error('Error saving journal:', result.error);
                            alert('Gagal menyimpan catatan jurnal: ' + result.error.message);
                            return;
                        }
                        
                        alert('Catatan jurnal berhasil ditambahkan!');
                    }
                    
                    renderJurnal();
                    
                    // Reset form and close modal
                    document.getElementById('jurnal-form').reset();
                    document.getElementById('tanggal-jurnal').valueAsDate = new Date();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tambahJurnalModal'));
                    modal.hide();
                } catch (error) {
                    console.error('Error in saveJurnal:', error);
                    alert('Terjadi kesalahan saat menyimpan catatan jurnal.');
                }
            }
        }
        
        async function renderJurnal() {
            const jurnalContainer = document.getElementById('daftar-jurnal');
            
            try {
                // Get teacher's journals with student data
                const { data, error } = await supabase
                    .from('journals')
                    .select(`
                        *,
                        students (id, nama, kelas)
                    `)
                    .eq('guru_id', currentGuru.id);
                
                if (error) {
                    console.error('Error loading journals:', error);
                    jurnalContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data jurnal</div>';
                    return;
                }
                
                if (data.length === 0) {
                    jurnalContainer.innerHTML = '<div class="alert alert-info">Belum ada catatan jurnal. Silakan tambahkan catatan baru.</div>';
                    return;
                }
                
                // Sort journals by date (newest first)
                const sortedJurnal = [...data].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                
                let html = '';
                sortedJurnal.forEach(jurnal => {
                    const kategoriText = {
                        '1': 'Pendampingan Akademik',
                        '2': 'Pengembangan Kompetensi dan Keterampilan',
                        '3': 'Pembentukan Karakter'
                    };
                    
                    const statusText = {
                        '1': 'Baik - Kondisi Positif',
                        '2': 'Perlu Perhatian - Butuh Monitoring',
                        '3': 'Butuh Bantuan - Perlu Intervensi'
                    };
                    
                    const tanggalFormatted = new Date(jurnal.tanggal).toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    html += `
                        <div class="journal-entry">
                            <div class="journal-date">${tanggalFormatted}</div>
                            <div class="mb-2">
                                <span class="journal-category category-${jurnal.kategori}">${kategoriText[jurnal.kategori]}</span>
                                <span class="status-badge status-${jurnal.status}">${statusText[jurnal.status]}</span>
                            </div>
                            <div class="journal-info">
                                <div class="journal-info-item">
                                    <i class="bi bi-person"></i>
                                    <strong>Siswa:</strong> ${jurnal.students.nama} (${jurnal.students.kelas})
                                </div>
                            </div>
                            <h6>Kegiatan yang Dilakukan:</h6>
                            <p>${jurnal.kegiatan}</p>
                            <h6>Evaluasi dan Tindak Lanjut:</h6>
                            <p>${jurnal.evaluasi_tindak_lanjut}</p>
                            <h6>Refleksi:</h6>
                            <p>${jurnal.refleksi}</p>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-warning" onclick="openEditJurnalModal('${jurnal.id}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteJurnal('${jurnal.id}')">
                                    <i class="bi bi-trash"></i> Hapus
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                jurnalContainer.innerHTML = html;
            } catch (error) {
                console.error('Error in renderJurnal:', error);
                jurnalContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data jurnal</div>';
            }
        }
        
        async function deleteJurnal(id) {
            if (confirm('Apakah Anda yakin ingin menghapus catatan jurnal ini?')) {
                try {
                    const { error } = await supabase
                        .from('journals')
                        .delete()
                        .eq('id', id);
                    
                    if (error) {
                        console.error('Error deleting journal:', error);
                        alert('Gagal menghapus catatan jurnal: ' + error.message);
                        return;
                    }
                    
                    renderJurnal();
                    alert('Catatan jurnal berhasil dihapus!');
                } catch (error) {
                    console.error('Error in deleteJurnal:', error);
                    alert('Terjadi kesalahan saat menghapus catatan jurnal.');
                }
            }
        }
        
        async function renderAnalisis() {
            const ringkasanContainer = document.getElementById('ringkasan-analisis');
            const analisisContainer = document.getElementById('daftar-analisis');
            
            try {
                // Get teacher's journals with student data
                const { data, error } = await supabase
                    .from('journals')
                    .select(`
                        *,
                        students (id, nama, kelas)
                    `)
                    .eq('guru_id', currentGuru.id);
                
                if (error) {
                    console.error('Error loading journals for analysis:', error);
                    ringkasanContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data analisis</div>';
                    analisisContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data analisis</div>';
                    return;
                }
                
                if (data.length === 0) {
                    ringkasanContainer.innerHTML = '<div class="alert alert-info">Belum ada data analisis. Silakan tambahkan catatan jurnal terlebih dahulu.</div>';
                    analisisContainer.innerHTML = '<div class="alert alert-info">Belum ada data analisis. Silakan tambahkan catatan jurnal terlebih dahulu.</div>';
                    return;
                }
                
                // Group journals by student
                const jurnalBySiswa = {};
                data.forEach(jurnal => {
                    const siswaKey = `${jurnal.students.nama} (${jurnal.students.kelas})`;
                    if (!jurnalBySiswa[siswaKey]) {
                        jurnalBySiswa[siswaKey] = [];
                    }
                    jurnalBySiswa[siswaKey].push(jurnal);
                });
                
                // Calculate summary
                const statusSummary = {
                    '1': 0,
                    '2': 0,
                    '3': 0
                };
                
                const kategoriSummary = {
                    '1': 0,
                    '2': 0,
                    '3': 0
                };
                
                data.forEach(jurnal => {
                    statusSummary[jurnal.status]++;
                    kategoriSummary[jurnal.kategori]++;
                });
                
                // Render summary
                let ringkasanHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Ringkasan Status Bimbingan</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Jumlah</th>
                                        <th>Presentase</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="status-badge status-1">Baik - Kondisi Positif</span></td>
                                        <td>${statusSummary['1']}</td>
                                        <td>${data.length > 0 ? Math.round((statusSummary['1'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td><span class="status-badge status-2">Perlu Perhatian - Butuh Monitoring</span></td>
                                        <td>${statusSummary['2']}</td>
                                        <td>${data.length > 0 ? Math.round((statusSummary['2'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td><span class="status-badge status-3">Butuh Bantuan - Perlu Intervensi</span></td>
                                        <td>${statusSummary['3']}</td>
                                        <td>${data.length > 0 ? Math.round((statusSummary['3'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Ringkasan Kategori Kegiatan</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Kategori</th>
                                        <th>Jumlah</th>
                                        <th>Presentase</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Pendampingan Akademik</td>
                                        <td>${kategoriSummary['1']}</td>
                                        <td>${data.length > 0 ? Math.round((kategoriSummary['1'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td>Pengembangan Kompetensi dan Keterampilan</td>
                                        <td>${kategoriSummary['2']}</td>
                                        <td>${data.length > 0 ? Math.round((kategoriSummary['2'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                    <tr>
                                        <td>Pembentukan Karakter</td>
                                        <td>${kategoriSummary['3']}</td>
                                        <td>${data.length > 0 ? Math.round((kategoriSummary['3'] / data.length) * 100) : 0}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                ringkasanContainer.innerHTML = ringkasanHtml;
                
                // Render detailed analysis
                let analisisHtml = '';
                
                Object.keys(jurnalBySiswa).forEach(siswaKey => {
                    const siswaJurnals = jurnalBySiswa[siswaKey];
                    const sortedJurnals = [...siswaJurnals].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                    
                    analisisHtml += `
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">${siswaKey}</div>
                                <div class="analysis-date">${siswaJurnals.length} catatan jurnal</div>
                            </div>
                    `;
                    
                    sortedJurnals.forEach(jurnal => {
                        const kategoriText = {
                            '1': 'Pendampingan Akademik',
                            '2': 'Pengembangan Kompetensi dan Keterampilan',
                            '3': 'Pembentukan Karakter'
                        };
                        
                        const statusText = {
                            '1': 'Baik - Kondisi Positif',
                            '2': 'Perlu Perhatian - Butuh Monitoring',
                            '3': 'Butuh Bantuan - Perlu Intervensi'
                        };
                        
                        const tanggalFormatted = new Date(jurnal.tanggal).toLocaleDateString('id-ID', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        analisisHtml += `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="journal-category category-${jurnal.kategori}">${kategoriText[jurnal.kategori]}</span>
                                        <span class="status-badge status-${jurnal.status}">${statusText[jurnal.status]}</span>
                                    </div>
                                    <small class="text-muted">${tanggalFormatted}</small>
                                </div>
                                <div class="mb-2">
                                    <strong>Kegiatan:</strong> ${jurnal.kegiatan}
                                </div>
                                <div class="mb-2">
                                    <strong>Evaluasi dan Tindak Lanjut:</strong> ${jurnal.evaluasi_tindak_lanjut}
                                </div>
                                <div>
                                    <strong>Refleksi:</strong> ${jurnal.refleksi}
                                </div>
                            </div>
                        `;
                    });
                    
                    analisisHtml += `
                        </div>
                    `;
                });
                
                analisisContainer.innerHTML = analisisHtml;
            } catch (error) {
                console.error('Error in renderAnalisis:', error);
                ringkasanContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data analisis</div>';
                analisisContainer.innerHTML = '<div class="alert alert-danger">Gagal memuat data analisis</div>';
            }
        }
        
        // Open print modal
        async function openCetakModal() {
            // Update siswa options
            const siswaSelect = document.getElementById('siswa-cetak');
            siswaSelect.innerHTML = '<option value="">Semua Siswa</option>';
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('guru_id', currentGuru.id);
                
                if (error) {
                    console.error('Error loading students for print:', error);
                    return;
                }
                
                if (data) {
                    data.forEach(siswa => {
                        const option = document.createElement('option');
                        option.value = siswa.id;
                        option.textContent = `${siswa.nama} (${siswa.kelas})`;
                        siswaSelect.appendChild(option);
                    });
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('cetakJurnalModal'));
                modal.show();
            } catch (error) {
                console.error('Error in openCetakModal:', error);
            }
        }
        
        async function prepareCetak() {
            const siswaId = document.getElementById('siswa-cetak').value;
            const tanggalMulai = document.getElementById('tanggal-mulai-cetak').value;
            const tanggalSelesai = document.getElementById('tanggal-selesai-cetak').value;
            
            try {
                // Build query
                let query = supabase
                    .from('journals')
                    .select(`
                        *,
                        students (id, nama, kelas, nis, nisn)
                    `)
                    .eq('guru_id', currentGuru.id);
                
                // Filter by student if selected
                if (siswaId) {
                    query = query.eq('siswa_id', siswaId);
                }
                
                // Filter by date range if provided
                if (tanggalMulai) {
                    query = query.gte('tanggal', tanggalMulai);
                }
                
                if (tanggalSelesai) {
                    query = query.lte('tanggal', tanggalSelesai);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('Error loading journals for print:', error);
                    document.getElementById('cetak-daftar-jurnal').innerHTML = '<div class="alert alert-danger">Gagal memuat data jurnal untuk dicetak</div>';
                    return;
                }
                
                // Sort filtered journals by date
                const sortedJurnal = [...data].sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
                
                // Get student data for identity section
                let studentData = null;
                if (siswaId) {
                    studentData = data.length > 0 ? data[0].students : null;
                } else if (sortedJurnal.length > 0) {
                    // If no specific student selected, use the first student from journals
                    studentData = sortedJurnal[0].students;
                }
                
                // Render student identity section (simplified without box and title)
                const studentIdentityContainer = document.getElementById('student-info-container');
                if (studentData) {
                    studentIdentityContainer.innerHTML = `
                        <div class="student-info-row">
                            <div class="student-info-label">Nama</div>
                            <div class="student-info-value">: ${studentData.nama}</div>
                        </div>
                        <div class="student-info-row">
                            <div class="student-info-label">Kelas</div>
                            <div class="student-info-value">: ${studentData.kelas}</div>
                        </div>
                        <div class="student-info-row">
                            <div class="student-info-label">NIS</div>
                            <div class="student-info-value">: ${studentData.nis}</div>
                        </div>
                        <div class="student-info-row">
                            <div class="student-info-label">NISN</div>
                            <div class="student-info-value">: ${studentData.nisn}</div>
                        </div>
                    `;
                } else {
                    studentIdentityContainer.innerHTML = '';
                }
                
                // Render filtered journals
                const cetakJurnalContainer = document.getElementById('cetak-daftar-jurnal');
                
                if (sortedJurnal.length === 0) {
                    cetakJurnalContainer.innerHTML = '<div class="alert alert-info">Tidak ada data jurnal untuk kriteria yang dipilih.</div>';
                } else {
                    let html = '';
                    
                    // Create table for print view
                    html += `
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th class="no">No</th>
                                    <th class="tanggal">Tanggal</th>
                                    <th>Kategori</th>
                                    <th class="status">Status</th>
                                    <th>Kegiatan</th>
                                    <th>Evaluasi</th>
                                    <th>Refleksi</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    sortedJurnal.forEach((jurnal, index) => {
                        const kategoriText = {
                            '1': 'Akademik',
                            '2': 'Kompetensi',
                            '3': 'Karakter'
                        };
                        
                        const statusText = {
                            '1': 'Baik',
                            '2': 'Perhatian',
                            '3': 'Bantuan'
                        };
                        
                        const tanggalFormatted = new Date(jurnal.tanggal).toLocaleDateString('id-ID', {
                            day: 'numeric',
                            month: 'numeric',
                            year: 'numeric'
                        });
                        
                        // Truncate long text for better print layout
                        const kegiatan = jurnal.kegiatan.length > 50 ? jurnal.kegiatan.substring(0, 50) + '...' : jurnal.kegiatan;
                        const evaluasi = jurnal.evaluasi_tindak_lanjut.length > 50 ? jurnal.evaluasi_tindak_lanjut.substring(0, 50) + '...' : jurnal.evaluasi_tindak_lanjut;
                        const refleksi = jurnal.refleksi.length > 50 ? jurnal.refleksi.substring(0, 50) + '...' : jurnal.refleksi;
                        
                        html += `
                            <tr>
                                <td class="no">${index + 1}</td>
                                <td class="tanggal">${tanggalFormatted}</td>
                                <td>${kategoriText[jurnal.kategori]}</td>
                                <td class="status">${statusText[jurnal.status]}</td>
                                <td>${kegiatan}</td>
                                <td>${evaluasi}</td>
                                <td>${refleksi}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    // Add signature section
                    html += `
                        <div class="signature-section">
                            <div class="signature-box">
                                <p>Mengetahui,</p>
                                <p class="jabatan">Kepala Sekolah</p>
                                <div class="signature-line"></div>
                                <p class="nama">${dataKepalaSekolah.nama || '_________________________'}</p>
                                <p class="nip">NIP. ${dataKepalaSekolah.nip || ''}</p>
                            </div>
                            <div class="signature-box">
                                <p>Medan, ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="jabatan">Guru Wali</p>
                                <div class="signature-line"></div>
                                <p class="nama">${currentGuru.nama}</p>
                                <p class="nip">NIP. ${currentGuru.nip || ''}</p>
                            </div>
                        </div>
                    `;
                    
                    cetakJurnalContainer.innerHTML = html;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('cetakJurnalModal'));
                modal.hide();
                
                // Show print page
                showPrintPage();
                
                // Wait for page to render, then print
                setTimeout(() => {
                    window.print();
                }, 500);
            } catch (error) {
                console.error('Error in prepareCetak:', error);
                document.getElementById('cetak-daftar-jurnal').innerHTML = '<div class="alert alert-danger">Gagal mempersiapkan data untuk dicetak</div>';
            }
        }
    </script>
</body>
</html>
